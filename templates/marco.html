<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tetrafolio: Marco</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/output.css" />
    <link rel="icon" type="image/x-icon" href="../assets/logo.webp" />
    <link rel="preload" href="../assets/marco-cropped.webp" as="image" />
  </head>
  <body class="overflow-x-hidden bg-black text-white">
    <nav class="flex items-center justify-between gap-4 border-b p-4">
      <a href="{{url_for('home')}}">
        <img
          loading="eager"
          fetchpriority="high"
          class="w-12 hover:motion-safe:animate-spin"
          src="../assets/logo.webp"
          alt="Logo"
        />
      </a>

      <div class="hidden items-center gap-2 lg:flex">
        <a href="{{url_for('matei')}}">
          <button
            class="cursor-pointer rounded-lg border bg-white p-1.5 px-4 text-black duration-300 hover:bg-blue-500"
          >
            Matei Ovidiu Serban
          </button>
        </a>
        <a href="{{url_for('lorenzo')}}">
          <button
            class="cursor-pointer rounded-lg border bg-white p-1.5 px-4 text-black duration-300 hover:bg-red-500"
          >
            Lorenzo Faccio
          </button>
        </a>
        <a href="#">
          <button
            class="cursor-pointer rounded-lg border bg-white p-1.5 px-4 text-black duration-300 hover:bg-green-500"
          >
            Marco Fediuc
          </button>
        </a>
        <a href="{{url_for('matteo')}}">
          <button
            class="cursor-pointer rounded-lg border bg-white p-1.5 px-4 text-black duration-300 hover:bg-yellow-400"
          >
            Jun Bao Matteo Qiu
          </button>
        </a>
        <button
          id="open-game-modal"
          class="group relative ml-4 inline-flex cursor-pointer items-center justify-center overflow-hidden text-nowrap rounded-lg bg-green-800 px-4 py-1.5 font-medium tracking-tighter text-white"
        >
          <span
            class="absolute h-0 w-0 rounded-full bg-yellow-600 transition-all duration-500 ease-out group-hover:h-56 group-hover:w-56"
          ></span>
          <span
            class="absolute inset-0 -mt-1 h-full w-full rounded-lg bg-gradient-to-b from-transparent via-transparent to-gray-700 opacity-30"
          ></span>
          <span class="relative">
            <span
              class="block opacity-100 transition-opacity duration-300 group-hover:opacity-0"
              >Change it up!</span
            >
            <span
              class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-300 group-hover:opacity-100"
              >Type away!</span
            >
          </span>
        </button>
      </div>

      <button
        id="hamburger-button"
        class="flex cursor-pointer flex-col items-center justify-center rounded-md bg-white p-2 lg:hidden"
      >
        <span class="mb-1 block h-[3px] w-6 bg-black"></span>
        <span class="mb-1 block h-[3px] w-6 bg-black"></span>
        <span class="mb-1 block h-[3px] w-6 bg-black"></span>
      </button>
    </nav>

    <div
      id="mobile-menu"
      class="fixed inset-0 z-50 hidden bg-[#1c1c1c] pt-4 text-white lg:hidden"
    >
      <div class="container mx-auto px-4">
        <div class="flex items-center justify-between">
          <img class="w-16" src="../assets/logo.webp" />
          <button
            id="close-menu"
            class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-white text-3xl text-black"
          >
            &times;
          </button>
        </div>
        <div class="mt-8 flex flex-col gap-4">
          <a href="{{url_for('matei')}}">
            <button
              class="w-full cursor-pointer rounded-lg border bg-white p-2 text-left text-black hover:bg-blue-500"
            >
              Matei Ovidiu Serban
            </button>
          </a>
          <a href="{{url_for('lorenzo')}}">
            <button
              class="w-full cursor-pointer rounded-lg border bg-white p-2 text-left text-black hover:bg-red-500"
            >
              Lorenzo Faccio
            </button>
          </a>
          <a href="#">
            <button
              class="w-full cursor-pointer rounded-lg border bg-white p-2 text-left text-black hover:bg-green-500"
            >
              Marco Fediuc
            </button>
          </a>
          <a href="{{url_for('matteo')}}">
            <button
              class="w-full cursor-pointer rounded-lg border bg-white p-2 text-left text-black hover:bg-yellow-400"
            >
              Jun Bao Matteo Qiu
            </button>
          </a>
          <div class="w-full">
            <input
              type="radio"
              id="state1"
              name="mobile-state"
              class="peer/default hidden"
              checked
            />
            <input
              type="radio"
              id="state2"
              name="mobile-state"
              class="peer/active hidden"
            />
            <label
              id="open-game-modal-mobile"
              for="state2"
              class="block w-full cursor-pointer rounded-lg bg-green-800 p-2 text-left text-white peer-checked/default:block peer-checked/active:hidden"
            >
              Change it up!
            </label>

            <label
              for="state1"
              class="hidden w-full cursor-pointer rounded-lg bg-yellow-600 p-2 text-left text-white peer-checked/active:block peer-checked/default:hidden"
            >
              Type away!
            </label>
          </div>
        </div>
      </div>
    </div>

    <div
      id="game-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm"
    >
      <div
        class="bg-bgColor relative mx-auto max-w-3xl rounded-lg p-6 shadow-xl"
      >
        <button
          id="close-game-modal"
          class="absolute -right-3 -top-3 flex h-8 w-8 items-center justify-center rounded-full bg-white text-2xl font-bold text-black hover:bg-gray-300"
        >
          &times;
        </button>

        <div class="text-textPrimary font-sans text-3xl">
          <div class="w-full max-w-[650px]">
            <div class="mb-5 flex items-center gap-2">
              <svg
                class="fill-primaryColor w-[40px]"
                version="1.1"
                id="Capa_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                viewBox="0 0 222.383 222.383"
                xml:space="preserve"
              >
                <g>
                  <path
                    d="M107.589,99.843l3.498,3.446l3.509-3.435c3.64-3.564,35.754-35.124,42.249-45.691c4.221-6.865,6.103-13.756,6.103-22.343
     C162.947,10.93,147.252,0,131.748,0c-8.532,0-15.62,2.934-20.61,8.404C107.319,4.226,100.901,0,90.568,0
     c-18.33,0-31.132,13.085-31.132,31.82c0,8.55,1.893,15.44,6.136,22.343C72.063,64.725,103.972,96.279,107.589,99.843z"
                  />
                  <path
                    d="M114.794,122.54l-3.498-3.446l-3.509,3.435c-3.64,3.564-35.753,35.123-42.249,45.691
     c-4.22,6.865-6.102,13.757-6.102,22.343c0,20.891,15.695,31.82,31.199,31.82c8.53,0,15.618-2.935,20.609-8.405
     c3.818,4.179,10.236,8.405,20.57,8.405c18.33,0,31.132-13.085,31.132-31.82c0-8.548-1.893-15.438-6.136-22.343
     C150.319,157.658,118.411,126.104,114.794,122.54z"
                  />
                  <path
                    d="M213.978,111.138c4.179-3.818,8.405-10.236,8.405-20.57c0-18.329-13.085-31.131-31.819-31.131
     c-8.551,0-15.441,1.893-22.343,6.136c-10.562,6.491-42.117,38.399-45.681,42.017l-3.446,3.498l3.435,3.509
     c3.564,3.64,35.124,35.754,45.691,42.249c6.863,4.22,13.755,6.102,22.344,6.102c20.89,0,31.819-15.694,31.819-31.198
     C222.383,123.217,219.448,116.129,213.978,111.138z"
                  />
                  <path
                    d="M99.843,114.794l3.446-3.498l-3.435-3.509c-3.564-3.64-35.123-35.754-45.69-42.249c-6.863-4.22-13.755-6.102-22.344-6.102
     C10.93,59.437,0,75.131,0,90.635c0,8.531,2.935,15.619,8.406,20.61C4.227,115.063,0,121.481,0,131.815
     c0,18.329,13.085,31.131,31.82,31.131c8.551,0,15.441-1.893,22.343-6.136C64.726,150.319,96.28,118.411,99.843,114.794z"
                  />
                </g>
              </svg>
              <h1 class="text-primaryColor text-3xl font-bold">TetraType</h1>
            </div>

            <div id="header" class="mb-8 mt-5 grid grid-cols-2 px-1.5">
              <div id="info" class="text-primaryColor"></div>
              <div id="buttons" class="text-right">
                <button
                  id="newGameBtn"
                  class="cursor-pointer rounded-[5px] bg-white/20 px-[20px] py-[5px] text-white/50 transition hover:bg-white/40 hover:text-white/80"
                >
                  New game
                </button>
              </div>
            </div>

            <div
              id="game"
              tabindex="0"
              class="group peer relative h-[110px] overflow-hidden leading-[35px] focus:outline-none"
            >
              <div
                id="words"
                class="text-textSecondary blur-[5px] transition-all duration-300 group-focus:blur-none peer-[.over]:opacity-50 peer-[.over]:blur-none"
              ></div>
              <div
                id="cursor"
                class="animate-blink bg-primaryColor fixed hidden h-[1.8rem] w-[2px] group-focus:block peer-[.over]:hidden"
              ></div>
              <div
                id="focus-error"
                class="absolute inset-0 pt-[35px] text-center group-focus:hidden peer-[.over]:hidden"
              >
                Click here to focus
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <section
      class="mx-auto flex max-w-7xl flex-col items-center justify-center gap-16 p-4 sm:flex-row sm:p-16"
    >
      <img
        src="../assets/marco-cropped.webp"
        class="min-h-[360px] w-[200px] rounded-[47%] border-4 border-green-600 lg:w-[250px]"
        alt="avatar"
      />
      <div class="w-[55%]">
        <div
          class="-gap-[10%] flex w-[70%] flex-col flex-col-reverse justify-between md:flex-row md:flex-col-reverse md:items-center"
        >
          <h2
            class="mt-4 whitespace-nowrap text-lg font-bold md:m-0 lg:text-xl"
          >
            Hi there! I'm
          </h2>
          <div class="flex items-center">
            <img
              class="mr-1 h-5 w-5 invert filter"
              src="../assets/location.png"
              alt=""
            />
            <h2 class="whitespace-nowrap text-xl font-bold">Pisa, Italy</h2>
          </div>
        </div>
        <h1
          class="mt-4 inline-block whitespace-nowrap bg-gradient-to-r from-white to-green-600 bg-clip-text text-3xl font-semibold tracking-tighter text-transparent sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl"
        >
          Marco Fediuc
        </h1>
        <p class="text-lg font-medium sm:w-[70%]">
          A computer science student who is looking forward to creating powerful
          backends for web applications.
        </p>
        <div
          class="mt-8 flex w-full items-center justify-center gap-12 sm:justify-start"
        >
          <a class="w-12" href="https://github.com/terabvte" target="_blank">
            <img src="../assets/github.png" alt="github" />
          </a>
          <a class="w-12" href="mailto:marcofediuc04@gmail.com" taget="_blank">
            <img src="../assets/mail.png" alt="mail" />
          </a>
          <a
            class="w-12"
            href="https://www.linkedin.com/in/marco-fediuc/"
            taget="_blank"
          >
            <img src="../assets/linkedin.png" alt="linkedin" />
          </a>
        </div>
      </div>
    </section>
    <div
      class="bg-linear-to-r mt-4 h-1 w-full from-green-300 to-green-500"
    ></div>

    <section
      class="Figmagradient lg:h-200 w-screen min-w-full overflow-hidden p-12 lg:relative"
    >
      <h1 class="-mt-4 mb-8 text-center text-4xl font-bold lg:mb-0">Skills</h1>

      <aside
        class="border-5 lg:top-25 mb-8 rounded-xl bg-black/70 p-4 shadow-2xl md:left-[23%] md:mx-auto md:w-[75%] lg:absolute lg:left-[23%] lg:mb-0 lg:w-[25%] xl:left-[23%] xl:top-32 2xl:left-[23%]"
      >
        <h2 class="mb-2 text-xl font-bold">Front-End</h2>
        <p class="mb-2 font-medium">
          One of the facets of web development I’m most interested at the
          moment. <br />
        </p>
        <p class="mb-4 font-medium">
          Currently learning React and upgrading my web UIs through the use of
          components.
        </p>
        <div class="mt-4 flex flex-wrap gap-6">
          <img class="w-8" src="../assets/html.png" alt="HTML Icon" />
          <img class="w-8" src="../assets/css.png" alt="CSS Icon" />
          <img class="w-8" src="../assets/js.png" alt="Javascript Icon" />
          <img class="w-8" src="../assets/ts.png" alt="Typescript Icon" />
          <img class="w-10" src="../assets/tailwind.png" alt="Tailwind Icon" />
          <img
            class="w-8 hover:motion-safe:animate-spin"
            src="../assets/react.png"
            alt="React Icon"
          />
        </div>
      </aside>
      <aside
        class="border-5 top-64 mb-8 rounded-xl bg-black/70 p-4 shadow-2xl md:right-[24%] md:mx-auto md:w-[75%] lg:absolute lg:right-[24%] lg:mb-0 lg:w-[25%] xl:right-[24%] 2xl:right-[24%]"
      >
        <h2 class="mb-2 text-xl font-bold">Back-End and General Programming</h2>
        <p class="mb-4 font-medium">
          My long term objective. Back-end brings to the table problems that in
          my opinion are more intriguing and thought-provoking.
        </p>
        <div class="mt-4 flex flex-wrap gap-6">
          <img class="w-10" src="../assets/c-sharp.png" alt="C# Icon" />
          <img class="w-10" src="../assets/dotnets.png" alt=".NET Core Icon" />
          <img class="w-10" src="../assets/c.png" alt="C Icon" />
          <img class="w-10" src="../assets/python.png" alt="Python Icon" />
          <img class="w-10" src="../assets/java.png" alt="Java Icon" />
        </div>
      </aside>
      <aside
        class="border-5 bottom-2 mb-8 rounded-xl bg-black/70 p-4 shadow-2xl md:left-[23%] md:mx-auto md:w-[75%] lg:absolute lg:left-[23%] lg:mb-0 lg:w-[25%] xl:bottom-16 xl:left-[23%] 2xl:left-[27%]"
      >
        <h2 class="mb-2 text-xl font-bold">Version-control</h2>
        <p class="mb-2 font-medium">
          A must in any programmer’s arsenal. <br />
          A VCS (Version Control System) allows the user to save snapshots of
          the code which allows for seamless collaboration and reversal in case
          of errors
        </p>
        <div class="mt-4 flex flex-wrap gap-4">
          <img class="w-8" src="../assets/github.png" alt="GitHub Icon" />
          <img class="w-8" src="../assets/git2.png" alt="Git Icon" />
        </div>
      </aside>
    </section>
    <div class="bg-linear-to-r h-1 w-full from-green-300 to-green-500"></div>
    <section class="h-[80%] bg-[#09090b]">
      <h1 class="mb-2 p-8 text-center text-4xl font-bold">Projects</h1>
      <div
        class="flex flex-col flex-col-reverse items-center justify-center gap-16 p-4 lg:flex-row"
      >
        <img
          id="food-img"
          class="w-[75%] cursor-pointer object-contain md:w-[70%] lg:w-[50%] xl:w-[50%]"
          src="../assets/omnifood.webp"
          alt="Image of the food website: Omnifood"
        />
        <div class="w-[80%] rounded-xl border-4 p-6 lg:h-[10%] lg:w-[25%]">
          <h2 class="mb-2 text-2xl font-bold">Omnifood</h2>
          <p>A static website created with HTML and CSS <br /></p>
          <ul class="mt-2 list-inside list-disc space-y-2">
            <li>
              Working with modern layouts using the following:
              <ul class="ml-6 list-inside list-disc space-y-2">
                <li>CSS Grid, like reusable grids.</li>
                <li>Flexbox, for navbar and centering.</li>
              </ul>
            </li>
            <li>Various modern website design rules</li>
            <li>
              More advanced styling with CSS (z-index, rem units, forms,
              semantic HTML, and more...)
            </li>
            <li>Responsive web design</li>
            <li>A very subtle introduction to Javascript</li>
            <li>
              ...and
              <a
                href="https://github.com/terabvte/omnifood"
                class="text-blue-500 underline"
                >much more</a
              >
            </li>
          </ul>
        </div>
      </div>
      <div
        class="mt-8 flex flex-col flex-col-reverse items-center justify-center gap-16 p-4 lg:flex-row-reverse"
      >
        <img
          id="pw-img"
          class="w-[75%] cursor-pointer object-contain md:w-[70%] lg:w-[50%] xl:w-[35%]"
          src="../assets/password.png"
          alt="Image of a Password Generator"
        />
        <div class="w-[80%] rounded-xl border-4 p-6 lg:h-[10%] lg:w-[25%]">
          <h2 class="mb-2 text-2xl font-bold">Password Generator</h2>
          <p>
            An interactive website made with Tailwind CSS and Javascript that
            generates two passwords at a time when clicking the button.
          </p>
          <p>What I've learned</p>
          <ul class="ml-6 list-inside list-disc space-y-2">
            <li>Getting more familiar with Tailwind’s utility classes</li>
            <li>Javascript DOM Manipulation</li>
            <li>Javascript Arrays and Array Methods</li>
          </ul>
        </div>
      </div>
    </section>
    <footer class="p-8">
      <div class="mb-6 mt-8 flex items-center justify-center gap-16">
        <a class="w-12" href="https://github.com/terabvte" target="_blank">
          <img src="../assets/github.png" alt="github" />
        </a>
        <a class="w-12" href="mailto:marcofediuc04@gmail.com" taget="_blank">
          <img src="../assets/mail.png" alt="mail" />
        </a>
        <a
          class="w-12"
          href="https://www.linkedin.com/in/marco-fediuc-9464b0238/"
          target="_blank"
        >
          <img src="../assets/linkedin.png" alt="curriculum" />
        </a>
      </div>
      <div class="flex flex-col justify-center">
        <h3 class="mb-2 text-center font-medium">Reach out to us at:</h3>
        <a
          href="{{url_for('contact_me')}}"
          class="mx-auto cursor-pointer rounded-lg bg-white p-2 px-4 text-center text-black"
        >
          <button class="cursor-pointer">Link to the form</button>
        </a>
      </div>
    </footer>
    <script>
      // ======================================================
      // === Existing Page Scripts (Unaffected) =============
      // ======================================================

      document
        .querySelector("#food-img")
        ?.addEventListener("click", function () {
          // Optional chaining ?. for safety
          window.location.href = "https://omnifood-tera.netlify.app/";
        });

      document.querySelector("#pw-img")?.addEventListener("click", function () {
        // Optional chaining ?. for safety
        window.location.href =
          "https://github.com/terabvte/web_learn?tab=readme-ov-file#password-generator";
      });

      // Hamburger Menu Logic
      document.addEventListener("DOMContentLoaded", function () {
        const hamburgerButton = document.getElementById("hamburger-button");
        const closeMenuButton = document.getElementById("close-menu");
        const mobileMenu = document.getElementById("mobile-menu");

        function openMenu() {
          if (!mobileMenu) return;
          mobileMenu.classList.remove("hidden");
          mobileMenu.classList.add("block");
          document.body.classList.add("overflow-hidden"); // Prevent scrolling main page
        }

        function closeMenu() {
          if (!mobileMenu) return;
          mobileMenu.classList.remove("block");
          mobileMenu.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        }

        if (hamburgerButton)
          hamburgerButton.addEventListener("click", openMenu);
        if (closeMenuButton)
          closeMenuButton.addEventListener("click", closeMenu);

        window.addEventListener("resize", function () {
          if (!mobileMenu) return;
          if (
            window.innerWidth >= 1024 &&
            mobileMenu.classList.contains("block")
          ) {
            closeMenu();
          }
        });
      });

      // ======================================================
      // === Typing Game & Modal Logic START ================
      // ======================================================

      // --- Game Setup & Constants ---
      const words =
        "in one good real one not school set they state high life consider on and not come what also for set point can want as while with of order child about school thing never hold find order each too between program work end you home place around while place problem end begin interest while public or where see time those increase interest be give end think seem small as both another a child same eye you between way do who into again good fact than under very head become real possible some write know however late each that with because that place nation only for each change form consider we would interest with world so order or run more open that large write turn never over open each over change still old take hold need give by consider line only leave while what set up number part form want against great problem can because head so first this here would course become help year first end want both fact public long word down also long for without new turn against the because write seem line interest call not if line thing what work people way may old consider leave hold want life between most place may if go who need fact such program where which end off child down change to from people high during people find to however into small new general it do that could old for last get another hand much eye great no work and with but good there last think can around use like number never since world need what we around part show new come seem while some and since still small these you general which seem will place come order form how about just also they with state late use both early too lead general seem there point take general seem few out like might under if ask while such interest feel word right again how about system such between late want fact up problem stand new say move a lead small however large public out by eye here over so be way use like say people work for since interest so face order school good not most run problem group run she late other problem real form what just high no man do under would to each too end point give number child through so this large see get form also all those course to work during about he plan still so like down he look down where course at who plan way so since come against he all who at world because while so few last these mean take house who old way large no first too now off would in this course present order home public school back own little about he develop of do over help day house stand present another by few come that down last or use say take would each even govern play around back under some line think she even when from do real problem between long as there school do as mean to all on other good may from might call world thing life turn of he look last problem after get show want need thing old other during be again develop come from consider the now number say life interest to system only group world same state school one problem between for turn run at very against eye must go both still all a as so after play eye little be those should out after which these both much house become both school this he real and may mean time by real number other as feel at end ask plan come turn by all head increase he present increase use stand after see order lead than system here ask in of look point little too without each for both but right we come world much own set we right off long those stand go both but under now must real general then before with much those at no of we only back these person plan from run new as own take early just increase only look open follow get that on system the mean plan man over it possible if most late line would first without real hand say turn point small set at in system however to be home show new again come under because about show face child know person large program how over could thing from out world while nation stand part run have look what many system order some one program you great could write day do he any also where child late face eye run still again on by as call high the must by late little mean never another seem to leave because for day against public long number word about after much need open change also".split(
          " ",
        );
      const wordsCount = words.length;
      const gameTime = 15 * 1000; // 15 seconds
      window.timer = null;
      window.gameStart = null;

      // --- Modal Element References ---
      const gameModal = document.getElementById("game-modal");
      const openGameModalBtn = document.getElementById("open-game-modal");
      const openGameModalBtnMobile = document.getElementById(
        "open-game-modal-mobile",
      );
      const closeGameModalBtn = document.getElementById("close-game-modal");
      const gameElementForFocus = document.getElementById("game");
      const newGameBtn = document.getElementById("newGameBtn"); // Inside modal

      // --- Basic Helper Functions ---
      function addClass(el, name) {
        if (el) el.classList.add(name);
      }
      function removeClass(el, name) {
        if (el) el.classList.remove(name);
      }
      function randomWord() {
        const randomIndex = Math.floor(Math.random() * wordsCount);
        return words[randomIndex];
      }
      function formatWord(word) {
        return `<div class="word inline-block font-mono mx-[5px]"><span class="letter">${word
          .split("")
          .join('</span><span class="letter">')}</span></div>`;
      }

      // --- WPM Calculation Function ---
      function getWpm() {
        const wordsElements = [...document.querySelectorAll("#game .word")];
        const currentWordElement = document.querySelector(
          "#game .word.current",
        );
        const currentWordIndex = currentWordElement
          ? wordsElements.indexOf(currentWordElement)
          : wordsElements.length;
        const typedWords = wordsElements.slice(0, currentWordIndex);
        let correctWordsCount = 0;

        typedWords.forEach((word) => {
          const letters = [...word.children];
          if (letters.length === 0) return;
          const hasTypedLetters = letters.some(
            (l) =>
              l.classList.contains("correct") ||
              l.classList.contains("incorrect") ||
              l.classList.contains("extra"),
          );
          if (!hasTypedLetters) return;
          let isCorrect = true;
          let hasIncorrectOrExtra = false;
          letters.forEach((letter) => {
            if (
              letter.classList.contains("incorrect") ||
              letter.classList.contains("extra")
            )
              hasIncorrectOrExtra = true;
            if (
              !letter.classList.contains("extra") &&
              !letter.classList.contains("correct")
            )
              isCorrect = false;
          });
          if (isCorrect && !hasIncorrectOrExtra) correctWordsCount++;
        });

        const endTime = new Date().getTime();
        const elapsedTimeMs = window.gameStart
          ? endTime - window.gameStart
          : gameTime;
        const elapsedTimeMinutes = Math.max(elapsedTimeMs / 60000, 1 / 60); // Min 1 sec
        return Math.round(correctWordsCount / elapsedTimeMinutes);
      }

      // --- Game State Functions (gameOver, newGame) ---
      function gameOver() {
        if (window.timer) {
          clearInterval(window.timer);
          window.timer = null;
        }
        const gameDiv = document.getElementById("game");
        const infoDiv = document.getElementById("info");
        const cursorEl = document.getElementById("cursor");
        if (gameDiv) addClass(gameDiv, "over");
        const result = getWpm();
        if (infoDiv) infoDiv.innerHTML = `WPM: ${result}`;
        if (cursorEl) cursorEl.style.visibility = "hidden"; // Hide cursor
      }

      function newGame() {
        if (window.timer) {
          clearInterval(window.timer);
          window.timer = null;
        }
        window.gameStart = null;
        const wordsContainer = document.getElementById("words");
        const gameDiv = document.getElementById("game");
        const infoDiv = document.getElementById("info");
        const cursorEl = document.getElementById("cursor");

        if (gameDiv) removeClass(gameDiv, "over");

        if (wordsContainer) {
          wordsContainer.innerHTML = "";
          for (let i = 0; i < 200; i++) {
            wordsContainer.innerHTML += formatWord(randomWord());
          }
          wordsContainer.style.marginTop = "0px"; // Reset scroll
          // Reset all statuses
          wordsContainer.querySelectorAll(".word, .letter").forEach((el) => {
            removeClass(el, "current");
            removeClass(el, "correct");
            removeClass(el, "incorrect");
            removeClass(el, "extra");
          });
          // Setup first word/letter
          const firstWord = wordsContainer.querySelector(".word");
          if (firstWord) {
            addClass(firstWord, "current");
            const firstLetter = firstWord.querySelector(".letter");
            if (firstLetter) {
              addClass(firstLetter, "current");
            }
          }
        }
        if (infoDiv) infoDiv.innerHTML = gameTime / 1000 + ""; // Reset timer display
        if (cursorEl) cursorEl.style.visibility = "hidden"; // Hide cursor initially
      }

      // --- Cursor Position Update Function ---
      function updateCursorPosition() {
        const finalCurrentLetter = document.querySelector(
          "#game .letter.current",
        );
        const finalCurrentWord = document.querySelector("#game .word.current");
        const cursorElement = document.getElementById("cursor");
        const gameElement = document.getElementById("game");
        if (
          !finalCurrentWord ||
          !cursorElement ||
          !gameElement ||
          gameElement.classList.contains("over")
        ) {
          if (cursorElement) cursorElement.style.visibility = "hidden";
          return;
        }
        let targetElement = finalCurrentLetter;
        let position = "left";
        if (!targetElement) {
          // Position cursor at end of word if no letter is current
          targetElement = finalCurrentWord.querySelector(
            ".letter:not(.extra):last-child",
          ); // Prefer last non-extra
          if (targetElement) position = "right";
          else {
            // Fallback to last letter of any kind, or word itself
            targetElement =
              finalCurrentWord.querySelector(".letter:last-child");
            if (targetElement) position = "right";
            else {
              targetElement = finalCurrentWord;
              position = "left";
            }
          }
        }
        cursorElement.style.visibility = "hidden"; // Force Hide before measure/move
        if (targetElement) {
          try {
            const clientRects = targetElement.getClientRects(); // Use getClientRects
            if (clientRects.length > 0) {
              const firstRect = clientRects[0];
              const lastRect = clientRects[clientRects.length - 1];
              const cursorTop = firstRect.top + 1; // Use first rect's top
              let cursorLeft =
                position === "left" ? firstRect.left : lastRect.right; // Use first/last rect left/right
              cursorElement.style.top = cursorTop + "px";
              cursorElement.style.left = cursorLeft + "px";
              cursorElement.style.visibility = "visible"; // Make visible again at new position
            } else {
              throw new Error("Element has no client rects.");
            }
          } catch (e) {
            console.error("Error positioning cursor:", e, targetElement);
            cursorElement.style.visibility = "hidden"; // Hide on error
          }
        } else {
          cursorElement.style.visibility = "hidden"; // Hide if somehow no target
        }
      }

      // --- Main Keydown Event Listener ---
      document.getElementById("game")?.addEventListener("keydown", (ev) => {
        // Initial variable setup
        const key = ev.key;
        const gameElement = document.getElementById("game");
        const wordsContainer = document.getElementById("words");
        const cursorElement = document.getElementById("cursor");
        const infoDiv = document.getElementById("info");

        if (
          !gameElement ||
          !wordsContainer ||
          !cursorElement ||
          gameElement.classList.contains("over")
        )
          return;

        const currentWordElement = gameElement.querySelector(".word.current");
        let currentLetterElement = gameElement.querySelector(".letter.current");

        const isLetter = key.length === 1 && key !== " ";
        const isSpace = key === " ";
        const isBackspace = key === "Backspace";
        const isShift = key === "Shift";

        // Ignore Shift key
        if (isShift) {
          ev.preventDefault();
          return;
        }
        // Prevent default for handled keys to avoid browser actions like scrolling
        if (isSpace || isBackspace) {
          ev.preventDefault();
        }

        // Start Timer Logic
        if (
          !window.timer &&
          currentWordElement &&
          (isLetter || isSpace) &&
          !window.gameStart
        ) {
          window.gameStart = new Date().getTime();
          window.timer = setInterval(() => {
            if (!window.gameStart) return; // Safety check
            const currentTime = new Date().getTime();
            const msPassed = currentTime - window.gameStart;
            const sLeft = Math.max(0, Math.round((gameTime - msPassed) / 1000));
            if (infoDiv) infoDiv.innerHTML = sLeft + "";
            if (sLeft <= 0) {
              gameOver();
            }
          }, 1000);
        }

        // State Update Logic
        if (isLetter && currentWordElement) {
          if (currentLetterElement) {
            // Typing inside a word
            addClass(
              currentLetterElement,
              key === currentLetterElement.innerHTML ? "correct" : "incorrect",
            );
            removeClass(currentLetterElement, "current");
            const nextLetter = currentLetterElement.nextElementSibling;
            if (nextLetter && nextLetter.classList.contains("letter")) {
              addClass(nextLetter, "current");
            }
          } else {
            // Typing extra letters
            const incorrectLetter = document.createElement("span");
            incorrectLetter.innerHTML = key;
            incorrectLetter.className = "letter incorrect extra";
            currentWordElement.appendChild(incorrectLetter);
          }
        } else if (isSpace && currentWordElement) {
          // Handle Space key
          // Mark all remaining/untyped original letters in current word as incorrect
          const lettersInWord = currentWordElement.querySelectorAll(
            ".letter:not(.extra)",
          );
          let foundCurrent = !currentLetterElement; // Start check from beginning if no letter is current
          lettersInWord.forEach((letter) => {
            if (letter === currentLetterElement) foundCurrent = true;
            // Mark as incorrect if it's at/after cursor and not already correct
            if (
              foundCurrent &&
              !letter.classList.contains("correct") &&
              !letter.classList.contains("incorrect")
            ) {
              addClass(letter, "incorrect");
            }
            removeClass(letter, "current"); // Make sure no letter in this word is current
          });

          // Move to next word
          removeClass(currentWordElement, "current");
          const nextWord = currentWordElement.nextElementSibling;
          if (nextWord && nextWord.classList.contains("word")) {
            addClass(nextWord, "current");
            const firstLetterOfNextWord = nextWord.querySelector(".letter");
            if (firstLetterOfNextWord) {
              addClass(firstLetterOfNextWord, "current");
            }
          } else {
            // End of words reached
            console.log("End of words on space.");
            if (window.timer) {
              // Only end game if timer is running
              const remainingWords = document.querySelectorAll(
                "#game .word.current ~ .word",
              );
              if (remainingWords.length === 0) {
                gameOver();
              } // Call game over if no words left
            }
          }
        } else if (isBackspace && currentWordElement) {
          // Handle Backspace key
          const lastExtraLetter = currentWordElement.querySelector(
            ".letter.extra:last-child",
          );

          if (lastExtraLetter) {
            // If extra letters exist, remove the last one
            currentWordElement.removeChild(lastExtraLetter);
          } else if (currentLetterElement) {
            // If cursor is on an original letter
            const prevLetter = currentLetterElement.previousElementSibling;
            // Clear status of the letter being deleted first
            removeClass(currentLetterElement, "current");
            removeClass(currentLetterElement, "correct");
            removeClass(currentLetterElement, "incorrect");

            if (prevLetter && prevLetter.classList.contains("letter")) {
              // If previous letter in same word exists
              addClass(prevLetter, "current"); // Move cursor back
              removeClass(prevLetter, "correct"); // Clear its status too
              removeClass(prevLetter, "incorrect");
            } else {
              // At the start of the word, move to previous word
              const prevWord = currentWordElement.previousElementSibling;
              if (prevWord && prevWord.classList.contains("word")) {
                removeClass(currentWordElement, "current"); // Leave current word
                addClass(prevWord, "current"); // Move to previous word
                // Make the last non-extra letter of prev word current (if exists)
                let targetLetterInPrev = prevWord.querySelector(
                  ".letter:not(.extra):last-child",
                );
                if (targetLetterInPrev) {
                  addClass(targetLetterInPrev, "current");
                  removeClass(targetLetterInPrev, "correct");
                  removeClass(targetLetterInPrev, "incorrect");
                } // else: cursor logic will handle end-of-word pos
              } // else: At the very beginning of the text
            }
          } else {
            // No current letter (cursor likely after word end) AND no extra letters
            // Try to move cursor to the end of the current word's original letters
            let targetLetter = currentWordElement.querySelector(
              ".letter:not(.extra):last-child",
            );
            if (targetLetter) {
              addClass(targetLetter, "current");
              removeClass(targetLetter, "correct");
              removeClass(targetLetter, "incorrect");
            } else {
              // Current word has no targetable letters, try previous word
              const prevWord = currentWordElement.previousElementSibling;
              if (prevWord && prevWord.classList.contains("word")) {
                removeClass(currentWordElement, "current");
                addClass(prevWord, "current");
                let targetLetterInPrev = prevWord.querySelector(
                  ".letter:not(.extra):last-child",
                );
                if (targetLetterInPrev) {
                  addClass(targetLetterInPrev, "current");
                  removeClass(targetLetterInPrev, "incorrect");
                  removeClass(targetLetterInPrev, "correct");
                } // else: cursor logic handles end-of-word pos
              } // else: At very beginning
            }
          }
        } // End state updates

        // Scroll Logic
        const activeWordForScroll = document.querySelector(
          "#game .word.current",
        );
        if (activeWordForScroll && wordsContainer && gameElement) {
          const gameRect = gameElement.getBoundingClientRect();
          const wordRect = activeWordForScroll.getBoundingClientRect();
          const currentMarginTop = parseInt(
            wordsContainer.style.marginTop || "0px",
          );
          const lineHeight = 35.1; // *** VERIFY THIS VALUE USING BROWSER DEV TOOLS ***

          // Scroll up (make space below) if word bottom is near/past game bottom
          if (wordRect.bottom > gameRect.bottom - lineHeight / 2) {
            // Threshold might need adjustment
            wordsContainer.style.marginTop =
              currentMarginTop - lineHeight + "px";
          }
          // Scroll down (show content above) if word top is above game top
          else if (wordRect.top < gameRect.top && currentMarginTop < 0) {
            wordsContainer.style.marginTop =
              currentMarginTop + lineHeight + "px";
          }
        }

        // Update Cursor Position using helper function in requestAnimationFrame
        requestAnimationFrame(updateCursorPosition);
      });

      // --- Modal Control Functions & Listeners ---
      function openGameModal() {
        if (gameModal && gameElementForFocus) {
          gameModal.classList.remove("hidden");
          gameModal.classList.add("flex");
          document.body.classList.add("overflow-hidden"); // Lock body scroll

          // Delay focus and cursor update slightly for modal animation/render
          setTimeout(() => {
            gameElementForFocus.focus();
            updateCursorPosition(); // Set initial cursor position
          }, 100); // Adjust delay if needed
        }
        // Close mobile menu if it's open when modal opens
        const mobileMenu = document.getElementById("mobile-menu");
        if (mobileMenu && mobileMenu.classList.contains("block")) {
          mobileMenu.classList.remove("block");
          mobileMenu.classList.add("hidden");
          document.body.classList.remove("overflow-hidden"); // Remove lock from menu
          // Re-add lock if modal is still displayed (it should be)
          if (gameModal && gameModal.classList.contains("flex")) {
            document.body.classList.add("overflow-hidden");
          }
        }
      }

      function closeGameModal() {
        if (gameModal && gameElementForFocus) {
          gameModal.classList.add("hidden");
          gameModal.classList.remove("flex");
          document.body.classList.remove("overflow-hidden"); // Unlock body scroll

          const cursorEl = document.getElementById("cursor");
          if (cursorEl) cursorEl.style.visibility = "hidden"; // Hide cursor

          if (typeof gameOver === "function") gameOver(); // End active game, calculate WPM
          if (typeof newGame === "function") newGame(); // Reset for next time

          gameElementForFocus.blur(); // Remove focus
        }
      }

      // Attach Modal Event Listeners
      if (openGameModalBtn)
        openGameModalBtn.addEventListener("click", openGameModal);
      if (openGameModalBtnMobile)
        openGameModalBtnMobile.addEventListener("click", openGameModal);
      if (closeGameModalBtn)
        closeGameModalBtn.addEventListener("click", closeGameModal);

      // Close modal on background click (optional)
      if (gameModal) {
        gameModal.addEventListener("click", (event) => {
          if (event.target === gameModal) {
            closeGameModal();
          } // Only close if clicking the overlay itself
        });
      }

      // Listener for the "New game" button *inside* the modal
      if (newGameBtn) {
        newGameBtn.addEventListener("click", () => {
          if (typeof newGame === "function") newGame(); // Start new game
          if (gameElementForFocus) {
            // Refocus
            setTimeout(() => {
              gameElementForFocus.focus();
              updateCursorPosition(); // Update cursor for new layout
            }, 50);
          }
        });
      }

      // --- Initial Game Setup On Load ---
      newGame(); // Set up the first game when the page loads

      // ======================================================
      // === Typing Game & Modal Logic END ==================
      // ======================================================
    </script>
  </body>
</html>
